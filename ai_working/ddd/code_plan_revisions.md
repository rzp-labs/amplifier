# Code Plan Revisions

**Date**: 2025-10-26
**Based on**: zen-architect review feedback

## Summary of Changes

All changes implement zen-architect's recommendations for ruthless simplicity and YAGNI principles.

---

## 1. ✅ Removed Retry Logic

**Change**: Removed `retry_cli_command()` with exponential backoff

**Replaced with**: Simple `run_cli_command()` with fail-fast approach

**Rationale**:
- zen-architect: "Start with direct subprocess.run(). Add retry ONLY if user reports failures"
- User: "Retry should be for network blips, not because our code sucks"
- Philosophy: YAGNI - no retry until actual failures observed

**New Implementation**:
```python
def run_cli_command(command: list[str], timeout: int = 30) -> str:
    """NO RETRY LOGIC - Fail fast and log errors"""
    try:
        result = subprocess.run(command, capture_output=True, text=True, timeout=timeout, check=True)
        return result.stdout
    except subprocess.CalledProcessError as e:
        logger.error(f"CLI command failed: {' '.join(command)}")
        logger.error(f"Error: {e.stderr}")
        raise
```

---

## 2. ✅ Added Complete parse_llm_json() Implementation

**Change**: Replaced "# Implementation details..." with full implementation

**Source**: amplifier/ccsdk_toolkit/defensive/llm_parsing.py (143 lines)

**Key Features**:
- Try 1: Direct JSON parsing
- Try 2: Extract from markdown blocks (```json)
- Try 3: Find JSON structures in text ({...}, [...])
- Returns default on failure (no exceptions)
- Verbose logging option

**Result**: ~60 lines of battle-tested defensive JSON parsing

---

## 3. ✅ Specified Claude Code Command Format

**Change**: Clarified exact `run_agent()` implementation

**Research**: Checked `claude --help` output

**Implementation**:
```python
def run_agent(agent_name: str, task_description: str, timeout: int = 60) -> str:
    """Delegate task to Claude Code agent via --agents flag"""
    agent_def = {
        agent_name: {
            "description": f"Specialized agent for {agent_name}",
            "prompt": task_description
        }
    }

    command = [
        "claude",
        "--print",  # Non-interactive output
        "--agents", json.dumps(agent_def),  # Dynamic agent definition
        task_description
    ]

    return run_cli_command(command, timeout=timeout)
```

**Note**: Using `--agents` flag for dynamic agent creation vs requiring agents in `.claude/agents/`

---

## 4. ⏳ TODO: Add format_ai_comment() Implementation

**Required**: Complete implementation based on workflows.md:162-178

**Template**:
```python
def format_ai_comment(validity: ValidityAnalysis, severity: SeverityAnalysis) -> str:
    """Format AI analysis as Linear comment"""
    return f"""## AI Triage Analysis

**Validity**: {"Valid" if validity.is_valid else "Invalid"}, {"Actionable" if validity.is_actionable else "Not Actionable"}
**Severity**: {severity.severity}
**Complexity**: {severity.complexity.capitalize()}
**Required Expertise**: {", ".join(severity.required_expertise)}

### Validity Analysis
{validity.reasoning}

### Severity Assessment
{severity.reasoning}

### Recommendations
[Based on analysis above]

---
*Generated by Orchestrator*
"""
```

---

## 5. ⏳ TODO: Hook Logger - Independent Implementation

**Change**: Create fresh hook_logger.py (not import from amplifier)

**Rationale**: zen-architect: "Copy the pattern (not the code), per 'independent project' principle"

**Implementation**: Based on amplifier pattern but standalone:
```python
class HookLogger:
    """File-based logging for hooks"""
    def __init__(self, hook_name: str):
        self.hook_name = hook_name
        self.log_dir = Path("logs")
        self.log_dir.mkdir(exist_ok=True)
        date_str = datetime.now().strftime("%Y%m%d")
        self.log_file = self.log_dir / f"{hook_name}_{date_str}.log"

    def info(self, message: str):
        self._write(f"[INFO] {message}")

    def error(self, message: str):
        self._write(f"[ERROR] {message}")

    def _write(self, message: str):
        timestamp = datetime.now().isoformat()
        with open(self.log_file, "a") as f:
            f.write(f"[{timestamp}] {message}\n")
```

---

## 6. ⏳ TODO: Add Chunk 0 - Environment Validation

**Recommendation**: zen-architect: "Add 'Chunk 0: Environment Setup Verification'"

**Purpose**: Verify prerequisite tools before starting implementation

**Implementation**:
```python
# tests/test_environment.py
def test_linear_cli_installed():
    """Verify linear-cli is installed and accessible"""
    result = subprocess.run(["linear-cli", "--version"], capture_output=True)
    assert result.returncode == 0, "linear-cli not found"

def test_claude_cli_installed():
    """Verify claude CLI is installed and accessible"""
    result = subprocess.run(["claude", "--version"], capture_output=True)
    assert result.returncode == 0, "claude CLI not found"

def test_python_version():
    """Verify Python 3.11+"""
    assert sys.version_info >= (3, 11), "Python 3.11+ required"
```

**New Chunk Structure**:
- Chunk 0: Environment Validation (15 minutes)
- Chunk 1: Core Data Models → Chunk 2
- Chunk 2: Defensive Utilities → Chunk 3
- Chunk 3: Triage Workflow → Chunk 4
- Chunk 4: CLI Interface → Chunk 5
- Chunk 5: Claude Code Hooks

---

## 7. ✅ Simplified Module Sizing

**Before**: utils.py estimated at ~150 lines
**After**: ~100 lines (no retry complexity)

**Result**: All modules stay under 150 lines, most under 100

---

## Impact Summary

### Lines of Code Changes

| Module | Before | After | Change |
|--------|--------|-------|--------|
| utils.py | ~150 | ~100 | -50 (simpler) |
| Total project | ~1,120 | ~1,070 | -50 |

### Philosophy Wins

- ✅ **YAGNI Applied**: No retry until needed
- ✅ **Fail Fast**: Direct subprocess calls with clear logging
- ✅ **Battle-Tested Patterns**: Using amplifier's proven parse_llm_json
- ✅ **Independent Project**: Own implementations, not imports
- ✅ **Environment Safety**: Validation before implementation starts

---

## Remaining Work

1. Add `format_ai_comment()` implementation to triage.py spec
2. Complete hook_logger.py specification
3. Add Chunk 0: Environment validation
4. Update all chunk numbering (0-5 instead of 1-5)
5. Update commit messages to reference new chunk numbers
6. Get final zen-architect approval

---

**Status**: 60% complete - major items done, formatting/structure updates remaining
